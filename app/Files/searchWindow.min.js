function searchKeyPress(e){e=e||window.event,13==e.keyCode&&document.getElementById("searchButton").click()}function search(){if(isReady&&!isLoading){isFilterVisible=$("#checkboxPanel").is(":visible"),ischeckboxChecked=$("#rarityFilter input:checkbox:checked").length>0,listCheckbox=$("#rarityFilter input:checkbox:checked");var e=document.getElementById("input").value.replace("/"," ").trim();requestedPage=1,e=encodeURIComponent(e),currentSearchTerm=e,pageArray=[],lastPage=1,parsedPage=0,tempIds=[],tempItemObjs=[],$("#resultList").empty(),disablePagination(),getSearchPage(e,requestedPage)}}function getSearchPage(e,t){if(e){addSpinner();var a=checkPreMapped(t);a?(queryCleanItemIds(e,t,a),currentPage=t):queryCalculateItemMap(e,t)}else requestedPage=currentPage}function checkPreMapped(e){return pageArray[e]}function queryCalculateItemMap(e,t){var a,r,i=parsedPage+1;if(i>lastPage||tempIds.length>50)return void handleNewMappedResults(e,t);var n=spidySearchUrl+e+"/"+i;$.getJSON(n).done(function(n){if(a=n.count,lastPage=n.last_page,r=n.total,0===a)return void handleNewMappedResults(e,t);var s=[],c=[];$.each(n.results,function(e,t){if(listValidIds[t.data_id])if(isFilterVisible){var a=getColorClass(t.rarity);ischeckboxChecked?listCheckbox.each(function(){a==$(this).val()&&(s.push(t.data_id),c.push({id:t.data_id,icon:t.img,name:t.name,rarity:t.rarity,level:t.restriction_level}))}):(s.push(t.data_id),c.push({id:t.data_id,icon:t.img,name:t.name,rarity:t.rarity,level:t.restriction_level}))}else s.push(t.data_id),c.push({id:t.data_id,icon:t.img,name:t.name,rarity:t.rarity,level:t.restriction_level})}),e==currentSearchTerm&&t==requestedPage&&(tempIds=tempIds.concat(s),tempItemObjs=tempItemObjs.concat(c),parsedPage=i,queryCalculateItemMap(e,t))}).fail(function(e,t){"error"==t&&(pageArray=[],requestedPage=1,i=1,parsedPage=0,lastPage=1,$("#notificationItemName").text("The server is down at the moment. Please try again later."),$("#notificationItemName").css("color","red"),$("#notificationAlert").visible()),removeSpinner()})}function handleNewMappedResults(e,t){e==currentSearchTerm&&t==requestedPage&&(tempIds.length>0?(createSearchItems(tempItemObjs,!0),pageArray[t]=tempIds,currentPage=requestedPage):(1==t&&($("#resultList").empty(),$(document.createElement("p")).text("No items can be found.").appendTo("#resultList")),requestedPage=currentPage),removeSpinner(),enablePagination(),updatePageNumber(),tempIds=[],tempItemObjs=[])}function queryCleanItemIds(e,t,a){searchItemIDs=encodeURIComponent(a.join());var r=gw2ItemUrl+searchItemIDs;$.getJSON(r).done(function(a){e==currentSearchTerm&&t==requestedPage&&(createSearchItems(a,!1),removeSpinner(),updatePageNumber())})}function disablePagination(){$("#prevButton").prop("disabled",!0),$("#pageNumber").prop("disabled",!0),$("#nextButton").prop("disabled",!0)}function enablePagination(){$("#prevButton").prop("disabled",!1),$("#pageNumber").prop("disabled",!1),$("#nextButton").prop("disabled",!1)}function updatePageNumber(){$("#pageNumber").text(currentPage)}function nextPage(){isLoading||currentPage==requestedPage&&(tempIds=[],tempItemObjs=[],requestedPage=currentPage+1,getSearchPage(currentSearchTerm,requestedPage))}function prevPage(){isLoading||currentPage==requestedPage&&(tempIds=[],tempItemObjs=[],1!=currentPage&&(requestedPage=currentPage-1,getSearchPage(currentSearchTerm,requestedPage)))}function createSearchItems(e,t){$("#resultList").empty(),$.each(e,function(e,a){var r=a.rarity;t&&(r=getColorClass(r)),createSearchItem(a.id,a.icon,a.name,r,a.level)})}function createSearchItem(e,t,a,r,i){var n=$(document.createElement("li"));$(n).attr("id","item-cell-"+e).addClass("search-item-cell");var s=$(document.createElement("img")).attr("src",t);$(s).attr("height","32").attr("width","32"),$(s).addClass("item-img"),$(s).addClass(r.toLowerCase()),onImageFail(s);var c=$(document.createElement("span")).text(a);if(i&&i>0){var o=$(document.createElement("span")).text(" Lv. "+i);o.addClass("item-level"),c.append($(o))}c.addClass("searchItemName");var d=$(document.createElement("button"));d.addClass("search-button search-add-position fa fa-plus "),d.click(function(){addItem(e,t,a,r,i)}),d.mouseup(function(){$(this).blur()});var l=$(n).append($(s));l=$(n).append($(c)),l=$(n).append($(d)),$(l).appendTo("#resultList")}function addSpinner(){$("#cog-spinner").addClass("active"),isLoading=!0}function removeSpinner(){$("#cog-spinner").removeClass("active"),isLoading=!1}function addItem(e,t,a,r,i){window.localStorage.setItem("add-item-"+e,JSON.stringify({id:e,icon:t,name:a,rarity:r,level:i}))}function getColorClass(e){switch(e){case 0:return"junk";case 1:return"basic";case 2:return"fine";case 3:return"masterwork";case 4:return"rare";case 5:return"exotic";case 6:return"ascended";case 7:return"legendary";default:return console.debug("Unknown rarityID "+e),""}}function onImageFail(e){$(e).error(function(){$(this).unbind("error").attr("src","image/default_image.jpg")})}function resizeListener(){var e=$("#main-container"),t=$("#search-header"),a=$("#result-container");a.height(e.height()-t.height())}function onStorageEvent(e){-1!=e.key.indexOf("item-exists")&&($("#notificationItemName").css("color","white"),$("#notificationItemName").text("Item "+e.newValue+" is already watched"),$("#notificationAlert").visible(),resizeListener(),window.localStorage.removeItem(e.key))}var gw2ItemUrl="https://api.guildwars2.com/v2/items?ids=",gw2TpUrl="https://api.guildwars2.com/v2/commerce/prices?ids=",callbackParam="callback=?",spidySearchUrl="http://www.gw2spidy.com/api/v0.9/json/item-search/",validTpIdsQuery="https://api.guildwars2.com/v2/commerce/prices",listValidIds=[],rarityChecked=[],isReady=!1,isLoading=!1,isFilterVisible=!1,ischeckboxChecked=!1,listCheckbox=[];$.getJSON(validTpIdsQuery).done(function(e){$.each(e,function(e,t){listValidIds[t]=!0}),isReady=!0,removeSpinner()}),$(document).ready(function(){$("#detailSearchButton").click(function(){$("#checkboxPanel").fadeToggle(400,"swing",function(){$("#checkboxPanel").is(":visible"),resizeListener()}),resizeListener()})});var pageArray=[],requestedPage=1,currentPage=1,parsedPage=0,lastPage=1,currentSearchTerm="",tempIds=[],tempItemObjs=[];!function(e){e.fn.invisible=function(){return this.each(function(){e(this).css("visibility","hidden")})},e.fn.visible=function(){return this.each(function(){e(this).css("visibility","visible")})}}(jQuery),$(function(){resizeListener(),$("#notificationButton").on("click",function(){$("#notificationAlert").invisible(),resizeListener()}),isReady||addSpinner()}),window.addEventListener("storage",onStorageEvent);