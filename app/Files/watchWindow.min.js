function drawHistChart(e,t){var a=new google.visualization.DataTable;a.addColumn("number","X"),a.addColumn("number","Buy"),a.addColumn("number","Sell");var n=new google.visualization.LineChart(e);listHistCharts[t]={chart:n,data:a},n.draw(a,chartHistOptions)}function addHistDataPoint(e,t,a){var n=listHistCharts[e],r=n.chart,i=n.data,o=new Date,l=i.getNumberOfRows();if(0==i.getNumberOfRows())for(var d=0;maxHistDataPoints>d;d++)i.addRow([o.getTime()-frequency*(maxHistDataPoints-d),t,a]);else l>=maxHistDataPoints&&i.removeRow(0);i.addRow([o.getTime(),t,a]),r.draw(i,chartHistOptions)}function drawSupplyChart(e,t){var a=new google.visualization.DataTable;a.addColumn("string","Bucket"),a.addColumn("number","Price"),a.addColumn({type:"string",role:"tooltip"}),a.addColumn({type:"string",role:"style"}),a.addColumn("number","Orders"),a.addColumn({type:"string",role:"tooltip"}),a.addColumn("number","Gap"),a.addColumn({type:"number",role:"interval"}),a.addColumn({type:"number",role:"interval"}),a.addColumn({type:"string",role:"tooltip"});var n=new google.visualization.ComboChart(e);listSupplyCharts[t]={chart:n,data:a},n.draw(a,chartSupplyOptions)}function getPriceTooltipString(e,t,a){var n=a?"Buy: ":"Sell: ";return n+e+"\nOrders: "+t}function updateSupplyChart(e,t,a){var n=listSupplyCharts[e],r=n.chart,i=n.data;i.removeRows(0,i.getNumberOfRows());var o=itemIdOptions[e].rescale;loadOfferRows(i,t,!0,o),a.length>0&&t.length>0&&loadFlipRow(i,t[0].unit_price,a[0].unit_price),loadOfferRows(i,a,!1,o),r.draw(i,chartSupplyOptions)}function loadFlipRow(e,t,a){var n=calculateFlipProfit(t,a);changeFlipColor(n.profit);var r="Listing Fee: "+n.listing+"\nExchange Fee: "+n.exchange+"\nProfit: "+n.profit,i=["flip",null,null,null,null,null,(t+a)/2,t,a,r];e.addRow(i)}function loadOfferRows(e,t,a,n){for(var r=[],i=Math.min(5,t.length),o=a?"b":"s",l=0;i>l;l++){var d=a?i-l-1:l,c=t[l].unit_price,s=t[l].quantity,u=getPriceTooltipString(c,s,a);n&&(s=Math.log(s+1)),r[d]=a?[o+l,c,u,"color:"+blueHex,s,u,null,null,null,null]:[o+l,c,u,"color: "+redHex,s,u,null,null,null,null]}e.addRows(r)}function calculateFlipProfit(e,t){var a=t-e,n=Math.max(Math.round(.05*t),1),r=Math.max(Math.round(.1*t),1),i=a-n-r;return{listing:n,exchange:r,profit:i}}function changeFlipColor(e){chartSupplyOptions.series[2].color=e>0?greenHex:redHex}function updateItemData(e){e=encodeURIComponent(e);var t="https://api.guildwars2.com/v2/items?ids="+e;$.getJSON(t).done(function(e){parseObjsAndUpdate(e)})}function parseObjsAndUpdate(e){itemIds=[],$.each(e,function(e,t){var a=t.name,n=t.icon,r=t.id;itemIds.push(r);var i=t.rarity,o=t.level;createWatchItem(r,a,i,n,o)}),updateItemPrices(itemIds,!0,!0)}function updateItemPrices(e,t,a){"undefined"==typeof e&&(e=listWatchItemId),"undefined"==typeof t&&(t=!0),"undefined"==typeof a&&(a=!0),e.length>0&&(t&&queryHistData(e),a&&querySupplyData(e))}function queryHistData(e){var t="https://api.guildwars2.com/v2/commerce/prices?ids="+e.join();$.getJSON(t).done(function(e){$.each(e,function(e,t){var a=t.sells.unit_price,n=t.buys.unit_price,r=t.id;addHistDataPoint(r,n,a),updatePriceHelper(r,n,"buy"),updatePriceHelper(r,a,"sell")})})}function querySupplyData(e){var t="https://api.guildwars2.com/v2/commerce/listings?ids="+e.join();$.getJSON(t).done(function(e){$.each(e,function(e,t){var a=t.sells,n=t.buys,r=t.id;updateSupplyChart(r,n,a)})})}function updatePriceHelper(e,t,a){var n=(t-t%1e4)/1e4,r=(t%1e4-t%100)/100,i=t%100;$("#"+e+"-"+a+"Copper").text(i),r>0||n>0?(n>0?($("#"+e+"-"+a+"Gold").text(n),$("#"+e+"-"+a+"GoldIcon").show()):($("#"+e+"-"+a+"Gold").empty(),$("#"+e+"-"+a+"GoldIcon").hide()),$("#"+e+"-"+a+"Silver").text(r),$("#"+e+"-"+a+"SilverIcon").show()):($("#"+e+"-"+a+"Gold").empty(),$("#"+e+"-"+a+"Silver").empty(),$("#"+e+"-"+a+"GoldIcon").hide(),$("#"+e+"-"+a+"SilverIcon").hide())}function createWatchItem(e,t,a,n,r){function i(e,t){t.fadeToggle(200,"linear"),m.toggleClass("fa-caret-down fa-caret-up")}var o=$(document.createElement("div"));o.attr("id","window-item-cell-"+e),o.addClass("mainWindow-item-cell");var l=$(document.createElement("img"));$(l).attr("src",n).attr("height","32").attr("width","32"),$(l).addClass(a.toLowerCase()+" item-img");var d=$(document.createElement("p")).text(t);if(d.addClass("item-name"),r&&r>0){var c=$(document.createElement("span")).text(" Lv. "+r);c.addClass("item-level"),d.append($(c))}var s=$(document.createElement("button"));s.addClass("item-button item-remove");var u=$(document.createElement("i"));u.addClass("fa fa-times  icon "),s.append(u),s.click(function(){removeItem(e)});var p=$(document.createElement("button"));p.addClass("item-button item-option");var m=$(document.createElement("i"));m.addClass("fa fa-lg fa-caret-down icon "),p.append(m);var h=createGraphCheckbox(e);p.click(function(){i(p,h)});var v=$(document.createElement("div")),f=$(document.createElement("div"));f.addClass("graph-buysell");var g=$(document.createElement("div"));g.addClass("chart-div"),g.attr("id","hist-chart-"+e),itemIdOptions[e].historical||g.hide(),drawHistChart($(g)[0],e),f.append(g);var I=$(document.createElement("div"));I.addClass("chart-div "),I.attr("id","supply-chart-"+e),itemIdOptions[e].stock||I.hide(),drawSupplyChart($(I)[0],e),f.append(I);var y=$(document.createElement("div")),w=createPriceElement(e,"buy"),C=createPriceElement(e,"sell");y.append(w,C),v.append(y,f);var b=o.append(l,d,p,s,h,v);$(b).appendTo("#main-container")}function createGraphCheckbox(e){var t=$(document.createElement("form"));t.hide(),t.prop("id","form-"+e);var a=$(document.createElement("div"));return a.append(createCheckBox(e,!1,"Historical Graph","historical")),a.append(createCheckBox(e,!1,"Stock Graph","stock")),a.append(createCheckBox(e,!0,"Rescale Bars","rescale")),t.append(a),t}function createCheckBox(e,t,a,n){var r=itemIdOptions[e][n],i=$(document.createElement("div"));i.addClass("checkbox-div"),t&&i.addClass("sub-checkbox");var o=$(document.createElement("label")),l=$(document.createElement("input")),d=$(document.createElement("span"));return o.attr("for",e+"-"+n+"-cb"),l.attr("type","checkbox"),l.attr("id",e+"-"+n+"-cb"),l.prop("checked",r),l.change(function(){var t=l.is(":checked");itemIdOptions[e][n]=t,saveItemOptions(),"historical"===n?t?$("#hist-chart-"+e).show():$("#hist-chart-"+e).hide():"stock"===n?t?$("#supply-chart-"+e).show():$("#supply-chart-"+e).hide():"rescale"===n&&updateItemPrices([e],!1,!0)}),o.append(d,a),i.append(l,o),i}function createPriceElement(e,t){var a="Sell:";"buy"==t&&(a="Buy:");var n=$(document.createElement("div")).addClass("pull-right"),r=$(document.createElement("div")).text(a);r.addClass("buy-sell"),"sell"==t&&r.addClass("pull-right"),r.append(n);var i=$(document.createElement("span"));$(i).attr("id",e+"-"+t+"Gold");var o=$(document.createElement("span"));$(o).attr("id",e+"-"+t+"Silver");var l=$(document.createElement("span")).text("0");$(l).attr("id",e+"-"+t+"Copper");var d=$(document.createElement("img")).attr("src","image/Gold_coin.png").attr("id",e+"-"+t+"GoldIcon"),c=$(document.createElement("img")).attr("src","image/Silver_coin.png").attr("id",e+"-"+t+"SilverIcon"),s=$(document.createElement("img")).attr("src","image/Copper_coin.png").attr("id",e+"-"+t+"CopperIcon");return $([d,c,s]).each(function(e,t){t.addClass("coin-align")}),$(d,c).hide(),n.append(i,d,o,c,l,s),r}function changeFrequency(){frequency=defaultFrequency;var e=window.localStorage.getItem("frequency");e&&(frequency=e),frequencyInterval&&window.clearInterval(frequencyInterval),frequencyInterval=setInterval(function(){listWatchItemId.length>0&&updateItemPrices(listWatchItemId,!0,!0)},frequency)}function removeItem(e){var t=listWatchItemId.indexOf(e);listWatchItemId.splice(t,1),delete listHistCharts[e],delete listSupplyCharts[e],delete itemIdOptions[e],saveItems(),$(".mainWindow-item-cell").remove("#window-item-cell-"+e),0==listWatchItemId.length&&$("#no-watch-item").show()}function saveItems(){saveItemList(),saveItemOptions()}function saveItemList(){window.localStorage.setItem("item-list-state",JSON.stringify(listWatchItemId))}function saveItemOptions(){for(var e=[],t=0;t<listWatchItemId.length;t++){var a=listWatchItemId[t];e.push({id:a,options:itemIdOptions[a]})}window.localStorage.setItem("item-options-state",JSON.stringify(e))}function reloadItemListState(){var e=window.localStorage.getItem("item-list-state"),t=JSON.parse(e);if(t&&t.length>0){listWatchItemId=t;var a=window.localStorage.getItem("item-options-state"),n=JSON.parse(a);if(n&&n.length>0)for(var r=0;r<n.length;r++){var i=n[r].id,o=n[r].options;itemIdOptions[i]=o}for(var r=0;r<listWatchItemId.length;r++){var l=listWatchItemId[r];itemIdOptions[l]||(itemIdOptions[l]=defaultItemOptions())}updateItemData(t)}else $("#no-watch-item").show()}function defaultItemOptions(){return{historical:!0,stock:!1,rescale:!1}}function onStorageEvent(e){if(-1!=e.key.indexOf("add-item-")){var t=JSON.parse(e.newValue),a=t.id;a&&-1==$.inArray(a,listWatchItemId)?(listWatchItemId.push(a),itemIdOptions[a]=defaultItemOptions(),saveItems(),parseObjsAndUpdate([t])):window.localStorage.setItem("item-exists",t.name),window.localStorage.removeItem(e.key),$("#no-watch-item").hide()}else if(-1!=e.key.indexOf("transparency-alpha")){var n=e.newValue,r="rgba("+defaultR+","+defaultG+","+defaultB+","+n+")";$("body").css("background-color",r)}else-1!=e.key.indexOf("frequency")&&changeFrequency()}function reloadTransparency(){var e=window.localStorage.getItem("transparency-alpha");if(e){var t=e,a="rgba("+defaultR+","+defaultG+","+defaultB+","+t+")";$("body").css("background-color",a)}}var listWatchItemId=[],itemIdOptions=[],listHistCharts=[],listSupplyCharts=[],defaultFrequency=1e4,orangeHex="#F0A000",redHex="#dc3912",blueHex="#3366cc",greenHex="#109618",defaultR="26",defaultG="33",defaultB="32",defaultA="0.8",maxHistDataPoints=20,chartHistOptions={backgroundColor:{fill:"transparent"},width:300,height:40,hAxis:{textPosition:"none",gridlines:{color:"transparent"},baseline:{color:"transparent"}},vAxis:{textPosition:"none",gridlines:{color:"transparent"},baseline:{color:"transparent"}},legend:{position:"none"},enableInteractivity:!1,tooltip:{trigger:"none"},chartArea:{left:2,top:2,width:296,height:36}},chartSupplyOptions={backgroundColor:{fill:"transparent"},vAxis:{gridlines:{color:"transparent"}},width:300,height:50,chartArea:{left:2,top:2,width:296,height:46},seriesType:"steppedArea",series:{0:{type:"line",targetAxisIndex:1,pointSize:5},1:{color:orangeHex},2:{type:"line",targetAxisIndex:1,lineWidth:0,intervals:{barWidth:"1",lineWidth:2}}},bar:{groupWidth:"80%"}};$(document).ready(function(){changeFrequency(),reloadItemListState(),reloadTransparency();var e=Loggr.logs.get("dj_dw2_tp_watcher","b439775d62ba4852b14520fa2618a81b");e.events.createEvent().text("app launched").tags("gw2tpwatcher").post()});var frequencyInterval,frequency;window.addEventListener("storage",onStorageEvent);